/**
 * @file Web Cryptography API shim
 * @author Artem S Vybornov <vybornov@gmail.com>
 * @license MIT
 */
!function(e){"use strict";function r(e){return btoa(e).replace(/\=+$/,"").replace(/\+/g,"-").replace(/\//g,"_")}function t(e){return e+="===",e=e.slice(0,-e.length%4),atob(e.replace(/-/g,"+").replace(/_/g,"/"))}function n(e){for(var r=new Uint8Array(e.length),t=0;t<e.length;t++)r[t]=e.charCodeAt(t);return r}function a(e){return e instanceof ArrayBuffer&&(e=new Uint8Array(e)),String.fromCharCode.apply(String,e)}function o(e){var r={name:(e.name||e||"").toUpperCase().replace("V","v")};switch(r.name){case"SHA-1":case"SHA-256":case"SHA-384":case"SHA-512":break;case"AES-CBC":case"AES-GCM":case"AES-KW":e.length&&(r.length=e.length);break;case"HMAC":e.hash&&(r.hash=o(e.hash)),e.length&&(r.length=e.length);break;case"RSAES-PKCS1-v1_5":e.publicExponent&&(r.publicExponent=new Uint8Array(e.publicExponent)),e.modulusLength&&(r.modulusLength=e.modulusLength);break;case"RSASSA-PKCS1-v1_5":case"RSA-OAEP":e.hash&&(r.hash=o(e.hash)),e.publicExponent&&(r.publicExponent=new Uint8Array(e.publicExponent)),e.modulusLength&&(r.modulusLength=e.modulusLength);break;default:throw new SyntaxError("Bad algorithm name")}return r}function i(e){return{HMAC:{"SHA-1":"HS1","SHA-256":"HS256","SHA-384":"HS384","SHA-512":"HS512"},"RSASSA-PKCS1-v1_5":{"SHA-1":"RS1","SHA-256":"RS256","SHA-384":"RS384","SHA-512":"RS512"},"RSAES-PKCS1-v1_5":{"":"RSA1_5"},"RSA-OAEP":{"SHA-1":"RSA-OAEP","SHA-256":"RSA-OAEP-256"},"AES-KW":{128:"A128KW",192:"A192KW",256:"A256KW"},"AES-GCM":{128:"A128GCM",192:"A192GCM",256:"A256GCM"},"AES-CBC":{128:"A128CBC",192:"A192CBC",256:"A256CBC"}}[e.name][(e.hash||{}).name||e.length||""]}function u(e){(e instanceof ArrayBuffer||e instanceof Uint8Array)&&(e=JSON.parse(decodeURIComponent(escape(a(e)))));var r={kty:e.kty,alg:e.alg,ext:e.ext||e.extractable};switch(r.kty){case"oct":r.k=e.k;case"RSA":["n","e","d","p","q","dp","dq","qi","oth"].forEach(function(t){t in e&&(r[t]=e[t])});break;default:throw new TypeError("Unsupported key type")}return r}function s(e){var r=u(e);return S&&(r.extractable=r.ext,delete r.ext),n(unescape(encodeURIComponent(JSON.stringify(r)))).buffer}function c(e){var t=l(e),n=!1;t.length>2&&(n=!0,t.shift());var o={ext:!0};switch(t[0][0]){case"1.2.840.113549.1.1.1":var i=["n","e","d","p","q","dp","dq","qi"],u=l(t[1]);n&&u.shift();for(var s=0;s<u.length;s++)u[s][0]||(u[s]=u[s].subarray(1)),o[i[s]]=r(a(u[s]));o.kty="RSA";break;default:throw new TypeError("Unsupported key type")}return o}function p(e){var r,a=[["",null]],o=!1;switch(e.kty){case"RSA":for(var i=["n","e","d","p","q","dp","dq","qi"],u=[],s=0;s<i.length&&i[s]in e;s++){var c=u[s]=n(t(e[i[s]]));128&c[0]&&(u[s]=new Uint8Array(c.length+1),u[s].set(c,1))}u.length>2&&(o=!0,u.unshift(new Uint8Array([0]))),a[0][0]="1.2.840.113549.1.1.1",r=u;break;default:throw new TypeError("Unsupported key type")}return a.push(new Uint8Array(y(r)).buffer),o?a.unshift(new Uint8Array([0])):a[1]={tag:3,value:a[1]},new Uint8Array(y(a)).buffer}function l(e,r){if(e instanceof ArrayBuffer&&(e=new Uint8Array(e)),r||(r={pos:0,end:e.length}),r.end-r.pos<2||r.end>e.length)throw new RangeError("Malformed DER");var t=e[r.pos++],n=e[r.pos++];if(n>=128){if(n&=127,r.end-r.pos<n)throw new RangeError("Malformed DER");for(var o=0;n--;)o<<=8,o|=e[r.pos++];n=o}if(r.end-r.pos<n)throw new RangeError("Malformed DER");var i;switch(t){case 2:i=e.subarray(r.pos,r.pos+=n);break;case 3:if(e[r.pos++])throw Error("Unsupported bit string");n--;case 4:i=new Uint8Array(e.subarray(r.pos,r.pos+=n)).buffer;break;case 5:i=null;break;case 6:var u=btoa(a(e.subarray(r.pos,r.pos+=n)));if(!(u in d))throw Error("Unsupported OBJECT ID "+u);i=d[u];break;case 48:i=[];for(var s=r.pos+n;r.pos<s;)i.push(l(e,r));break;default:throw Error("Unsupported DER tag 0x"+t.toString(16))}return i}function y(e,r){r||(r=[]);var t=0,a=0,o=r.length+2;if(r.push(0,0),e instanceof Uint8Array){t=2,a=e.length;for(var i=0;a>i;i++)r.push(e[i])}else if(e instanceof ArrayBuffer){t=4,a=e.byteLength,e=new Uint8Array(e);for(var i=0;a>i;i++)r.push(e[i])}else if(null===e)t=5,a=0;else if("string"==typeof e&&e in k){var u=n(atob(k[e]));t=6,a=u.length;for(var i=0;a>i;i++)r.push(u[i])}else if(e instanceof Array){for(var i=0;i<e.length;i++)y(e[i],r);t=48,a=r.length-o}else{if(!("object"==typeof e&&3===e.tag&&e.value instanceof ArrayBuffer))throw Error("Unsupported DER value "+e);e=new Uint8Array(e.value),t=3,a=e.byteLength,r.push(0);for(var i=0;a>i;i++)r.push(e[i]);a++}if(a>=128){var s=a,a=4;for(r.splice(o,0,s>>24&255,s>>16&255,s>>8&255,255&s);a>1&&!(s>>24);)s<<=8,a--;4>a&&r.splice(o,4-a),a|=128}return r.splice(o-2,2,t,a),r}function f(e,r,t,n){Object.defineProperties(this,{_key:{value:e},type:{value:e.type,enumerable:!0},extractable:{value:void 0===t?e.extractable:t,enumerable:!0},algorithm:{value:void 0===r?e.algorithm:r,enumerable:!0},usages:{value:void 0===n?e.usages:n,enumerable:!0}})}function h(e){return"verify"===e||"encrypt"===e||"wrapKey"===e}function g(e){return"sign"===e||"decrypt"===e||"unwrapKey"===e}if("function"!=typeof Promise)throw"Promise support required";var A=e.crypto||e.msCrypto;if(A){var m=A.subtle||A.webkitSubtle;if(m){var b=e.Crypto||A.constructor||Object,w=e.SubtleCrypto||m.constructor||Object,S=(e.CryptoKey||e.Key||Object,!!e.msCrypto),v=!!A.webkitSubtle;if(S||v){var d={KoZIhvcNAQEB:"1.2.840.113549.1.1.1"},k={"1.2.840.113549.1.1.1":"KoZIhvcNAQEB"};if(["generateKey","importKey","unwrapKey"].forEach(function(e){var r=m[e];m[e]=function(a,p,l){var y,b,w,d=[].slice.call(arguments);switch(e){case"generateKey":y=o(a),b=p,w=l;break;case"importKey":y=o(l),b=d[3],w=d[4],"jwk"===a&&(p=u(p),p.alg||(p.alg=i(y)),p.key_ops||(p.key_ops="oct"!==p.kty?w.filter("d"in p?g:h):w.slice()),d[1]=s(p));break;case"unwrapKey":y=d[4],b=d[5],w=d[6],d[2]=l._key}if("generateKey"===e&&"HMAC"===y.name&&y.hash)return y.length=y.length||{"SHA-1":512,"SHA-256":512,"SHA-384":1024,"SHA-512":1024}[y.hash.name],m.importKey("raw",A.getRandomValues(new Uint8Array(y.length+7>>3)),y,b,w);if(v&&"generateKey"===e&&"RSASSA-PKCS1-v1_5"===y.name&&(!y.modulusLength||y.modulusLength>=2048))return a=o(a),a.name="RSAES-PKCS1-v1_5",delete a.hash,m.generateKey(a,!0,["encrypt","decrypt"]).then(function(e){return Promise.all([m.exportKey("jwk",e.publicKey),m.exportKey("jwk",e.privateKey)])}).then(function(e){return e[0].alg=e[1].alg=i(y),e[0].key_ops=w.filter(h),e[1].key_ops=w.filter(g),Promise.all([m.importKey("jwk",e[0],y,b,e[0].key_ops),m.importKey("jwk",e[1],y,b,e[1].key_ops)])}).then(function(e){return{publicKey:e[0],privateKey:e[1]}});if((v||S&&"SHA-1"===(y.hash||{}).name)&&"importKey"===e&&"jwk"===a&&"HMAC"===y.name&&"oct"===p.kty)return m.importKey("raw",n(t(p.k)),l,d[3],d[4]);if(v&&"importKey"===e&&("spki"===a||"pkcs8"===a))return m.importKey("jwk",c(p),l,d[3],d[4]);if(S&&"unwrapKey"===e)return m.decrypt(d[3],l,p).then(function(e){return m.importKey(a,e,d[4],d[5],d[6])});var k;try{k=r.apply(m,d)}catch(K){return Promise.reject(K)}return S&&(k=new Promise(function(e,r){k.onabort=k.onerror=function(e){r(e)},k.oncomplete=function(r){e(r.target.result)}})),k=k.then(function(e){return"HMAC"===y.name&&(y.length||(y.length=8*e.algorithm.length)),0==y.name.search("RSA")&&(y.modulusLength||(y.modulusLength=(e.publicKey||e).algorithm.modulusLength),y.publicExponent||(y.publicExponent=(e.publicKey||e).algorithm.publicExponent)),e=e.publicKey&&e.privateKey?{publicKey:new f(e.publicKey,y,b,w.filter(h)),privateKey:new f(e.privateKey,y,b,w.filter(g))}:new f(e,y,b,w)})}}),["exportKey","wrapKey"].forEach(function(e){var t=m[e];m[e]=function(o,s,c){var l=[].slice.call(arguments);switch(e){case"exportKey":l[1]=s._key;break;case"wrapKey":l[1]=s._key,l[2]=c._key}if((v||S&&"SHA-1"===(s.algorithm.hash||{}).name)&&"exportKey"===e&&"jwk"===o&&"HMAC"===s.algorithm.name&&(l[0]="raw"),!v||"exportKey"!==e||"spki"!==o&&"pkcs8"!==o||(l[0]="jwk"),S&&"wrapKey"===e)return m.exportKey(o,s).then(function(e){return"jwk"===o&&(e=n(unescape(encodeURIComponent(JSON.stringify(u(e)))))),m.encrypt(l[3],c,e)});var y;try{y=t.apply(m,l)}catch(f){return Promise.reject(f)}return S&&(y=new Promise(function(e,r){y.onabort=y.onerror=function(e){r(e)},y.oncomplete=function(r){e(r.target.result)}})),"exportKey"===e&&"jwk"===o&&(y=y.then(function(e){return(v||S&&"SHA-1"===(s.algorithm.hash||{}).name)&&"HMAC"===s.algorithm.name?{kty:"oct",alg:i(s.algorithm),key_ops:s.usages.slice(),ext:!0,k:r(a(e))}:(e=u(e),e.alg||(e.alg=i(s.algorithm)),e.key_ops||(e.key_ops="public"===s.type?s.usages.filter(h):"private"===s.type?s.usages.filter(g):s.usages.slice()),e)})),!v||"exportKey"!==e||"spki"!==o&&"pkcs8"!==o||(y=y.then(function(e){return e=p(u(e))})),y}}),["encrypt","decrypt","sign","verify"].forEach(function(e){var r=m[e];m[e]=function(t,n,a,i){if(S&&(!a.byteLength||i&&!i.byteLength))throw Error("Empy input is not allowed");var u=[].slice.call(arguments),s=o(t);if(S&&"decrypt"===e&&"AES-GCM"===s.name){var c=t.tagLength>>3;u[2]=(a.buffer||a).slice(0,a.byteLength-c),t.tag=(a.buffer||a).slice(a.byteLength-c)}u[1]=n._key;var p;try{p=r.apply(m,u)}catch(l){return Promise.reject(l)}return S&&(p=new Promise(function(r,t){p.onabort=p.onerror=function(e){t(e)},p.oncomplete=function(t){var t=t.target.result;if("encrypt"===e&&t instanceof AesGcmEncryptResult){var n=t.ciphertext,a=t.tag;t=new Uint8Array(n.byteLength+a.byteLength),t.set(new Uint8Array(n),0),t.set(new Uint8Array(a),n.byteLength),t=t.buffer}r(t)}})),p}}),S){var K=m.digest;m.digest=function(e,r){if(!r.byteLength)throw Error("Empy input is not allowed");var t;try{t=K.call(m,e,r)}catch(n){return Promise.reject(n)}return t=new Promise(function(e,r){t.onabort=t.onerror=function(e){r(e)},t.oncomplete=function(r){e(r.target.result)}})},e.crypto=Object.create(A,{getRandomValues:{value:function(e){return A.getRandomValues(e)}},subtle:{value:m}}),e.CryptoKey=f}v&&(A.subtle=m,e.Crypto=b,e.SubtleCrypto=w,e.CryptoKey=f)}}}}(this);